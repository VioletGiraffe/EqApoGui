name: Build Windows Installer

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      deployments: write
      pull-requests: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # required to access full history and tags
        fetch-tags: true

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.9.*'
        host: windows
        target: desktop
        arch: win64_msvc2022_64

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build installer
      shell: cmd
      run: |
        build_installer.bat

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: EqApoGuiSetup
        path: EqApoGuiSetup.exe
        if-no-files-found: error

    - name: Generate changelog (commits between previous tag and this tag)
      id: changelog
      shell: pwsh
      env:
        GITHUB_SERVER_URL: ${{ github.server_url }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        CURRENT_REF: ${{ github.ref }}
      run: |
        $ErrorActionPreference = "Stop"

        # Extract current tag name (strip refs/tags/)
        $currentTag = $env:CURRENT_REF -replace '^refs/tags/', ''

        # Ensure tags are present
        git fetch --tags --prune

        # Find previous tag (newest first, excluding current tag)
        $tags = git tag --sort=-creatordate
        $prevTag = $tags | Where-Object { $_ -ne $currentTag } | Select-Object -First 1

        if ([string]::IsNullOrEmpty($prevTag)) {
          $title = "Changes up to $currentTag"

          $commits = git log `
            $currentTag `
            --pretty=format:"- %s ([%h]($($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/commit/%H))"
        }
        else {
          $title = "Changes since $prevTag"

          # Resolve the commit the previous tag points to and exclude it explicitly
          $prevCommit = git rev-list -n 1 $prevTag

          $commits = git log `
            $currentTag `
            --not $prevCommit `
            --pretty=format:"- %s ([%h]($($env:GITHUB_SERVER_URL)/$($env:GITHUB_REPOSITORY)/commit/%H))"
        }

        if ([string]::IsNullOrWhiteSpace($commits)) {
          $commits = "(no commits)"
        }

        # Write multiline output for softprops/action-gh-release
        "body<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        "$title`n"  | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        $commits    | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        "EOF"       | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

    - name: Create Release (on tag)
      uses: softprops/action-gh-release@v2
      if: success() && startsWith(github.ref, 'refs/tags/')
      with:
        files: EqApoGuiSetup.exe
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref }}
        name: ${{ github.ref_name }}
        body: ${{ steps.changelog.outputs.body }}